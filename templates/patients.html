{% extends "base.html" %}
{% block title %}Patients{% endblock %}

{% block content %}
<h1>Patients</h1>

{% if message %}
  <p style="color:#2e7d32; font-weight:600;">{{ message }}</p>
{% endif %}

<!-- =========================
     Add Patient (SQLite DB)
     ========================= -->
<h3>Add Patient</h3>
<form method="post" action="{{ url_for('patients') }}" style="margin-bottom:1rem;">
  <label>Name:</label>
  <input name="name" required>

  <label style="margin-left:1rem;">Age:</label>
  <input name="age" required style="width:6rem;">

  <label style="margin-left:1rem;">Condition:</label>
  <input name="condition" required style="width:16rem;">

  <button type="submit" style="margin-left:1rem;">Add Patient</button>
</form>

<!-- =========================
     Existing Patients (SQLite)
     ========================= -->
<h3>Existing Patients (DB)</h3>
<table border="1" cellpadding="6" cellspacing="0"
       style="border-collapse:collapse; width:100%; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Age</th>
      <th>Condition</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% if patients %}
      {% for p in patients %}
        <tr>
          <form method="post" action="{{ url_for('update_patient') }}">
            <td>
              <input name="id" value="{{ p[0] }}" readonly
                     style="width:4rem; background:#f6f6f6;">
            </td>
            <td><input name="name" value="{{ p[1] }}" required></td>
            <td><input name="age" value="{{ p[2] }}" required style="width:5rem;"></td>
            <td><input name="condition" value="{{ p[3] }}" required></td>
            <td>
              <button type="submit">Update</button>
              <button type="submit"
                      formaction="{{ url_for('delete_patient') }}"
                      onclick="return confirm('Delete patient ID {{ p[0] }}?');">
                Delete
              </button>
            </td>
          </form>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" style="text-align:center; color:#666;">
          No patients found.
        </td>
      </tr>
    {% endif %}
  </tbody>
</table>

<!-- =========================
     Stroke CSV (UPDATE / DELETE)
     ========================= -->
<h3>Stroke Data (from stroke_data.csv)</h3>

{% set cols = [
  'id','gender','age','hypertension','heart_disease','ever_married',
  'work_type','Residence_type','avg_glucose_level','bmi','smoking_status','stroke'
] %}

{% if csv_rows %}
  <div style="max-width:100%; overflow:auto; border:1px solid #ddd; padding:.5rem;">
    <table border="1" cellpadding="6" cellspacing="0"
           style="border-collapse:collapse; width:100%;">
      <thead>
        <tr>
          {% for c in cols %}
            {% if c in csv_rows[0] %}
              <th>{{ c }}</th>
            {% endif %}
          {% endfor %}
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for row in csv_rows %}
          <tr>
            <form method="post">
              <input type="hidden" name="row_index" value="{{ row._idx }}">

              {% for c in cols %}
                {% if c in row %}
                  <td>
                    {% if c == 'id' %}
                      <input name="{{ c }}" value="{{ row[c] }}"
                             readonly style="width:90px; background:#f6f6f6;">
                    {% else %}
                      <input name="{{ c }}" value="{{ row[c] }}" style="width:90px;">
                    {% endif %}
                  </td>
                {% endif %}
              {% endfor %}

              <td>
                <button type="submit"
                        formaction="{{ url_for('update_stroke_row') }}">
                  Update
                </button>
                <button type="submit"
                        formaction="{{ url_for('delete_stroke_row') }}"
                        onclick="return confirm('Delete this CSV row?');">
                  Delete
                </button>
              </td>
            </form>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div style="margin-top:.75rem; display:flex; gap:.5rem; align-items:center;">
    <span>Rows per page: {{ page_size }} | Total: {{ total_rows }}</span>

    <div style="margin-left:auto;">
      {% if page > 1 %}
        <a href="{{ url_for('patients', page=page-1) }}">Prev</a>
      {% else %}
        <span style="color:#aaa;">Prev</span>
      {% endif %}

      <span style="padding:0 .5rem;">Page {{ page }} / {{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_for('patients', page=page+1) }}">Next</a>
      {% else %}
        <span style="color:#aaa;">Next</span>
      {% endif %}
    </div>
  </div>
{% else %}
  <p style="color:#666;">No CSV rows found.</p>
{% endif %}

{% endblock %}
